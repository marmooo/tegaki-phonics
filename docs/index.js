class t{constructor(e,t,n,s){if(isNaN(e)||isNaN(t))throw new Error(`Point is invalid: (${e}, ${t})`);this.x=+e,this.y=+t,this.pressure=n||0,this.time=s||Date.now()}distanceTo(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}equals(e){return this.x===e.x&&this.y===e.y&&this.pressure===e.pressure&&this.time===e.time}velocityFrom(e){return this.time!==e.time?this.distanceTo(e)/(this.time-e.time):0}}class e{static fromPoints(t,n){const s=this.calculateControlPoints(t[0],t[1],t[2]).c2,o=this.calculateControlPoints(t[1],t[2],t[3]).c1;return new e(t[1],s,o,t[2],n.start,n.end)}static calculateControlPoints(e,n,s){const r=e.x-n.x,u=e.y-n.y,d=n.x-s.x,a=n.y-s.y,c=(e.x+n.x)/2,l=(e.y+n.y)/2,o=(n.x+s.x)/2,i=(n.y+s.y)/2,g=Math.sqrt(r*r+u*u),h=Math.sqrt(d*d+a*a),m=h/(g+h),v=o+(c-o)*m,b=i+(l-i)*m,f=n.x-v,p=n.y-b;return{c1:new t(c+f,l+p),c2:new t(o+f,i+p)}}constructor(e,t,n,s,o,i){this.startPoint=e,this.control2=t,this.control1=n,this.endPoint=s,this.startWidth=o,this.endWidth=i}length(){let e,t,n=0;for(let s=0;s<=10;s+=1){const o=s/10,i=this.point(o,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),a=this.point(o,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(s>0){const s=i-e,o=a-t;n+=Math.sqrt(s*s+o*o)}e=i,t=a}return n}point(e,t,n,s,o){return t*(1-e)*(1-e)*(1-e)+3*n*(1-e)*(1-e)*e+3*s*(1-e)*e*e+o*e*e*e}}class i{constructor(){try{this._et=new EventTarget}catch{this._et=document}}addEventListener(e,t,n){this._et.addEventListener(e,t,n)}dispatchEvent(e){return this._et.dispatchEvent(e)}removeEventListener(e,t,n){this._et.removeEventListener(e,t,n)}}class s extends i{constructor(e,t={}){super(),this.canvas=e,this._drawingStroke=!1,this._isEmpty=!0,this._lastPoints=[],this._data=[],this._lastVelocity=0,this._lastWidth=0,this._handleMouseDown=e=>{1===e.buttons&&this._strokeBegin(e)},this._handleMouseMove=e=>{this._strokeMoveUpdate(e)},this._handleMouseUp=e=>{1===e.buttons&&this._strokeEnd(e)},this._handleTouchStart=e=>{if(e.cancelable&&e.preventDefault(),1===e.targetTouches.length){const t=e.changedTouches[0];this._strokeBegin(t)}},this._handleTouchMove=e=>{e.cancelable&&e.preventDefault();const t=e.targetTouches[0];this._strokeMoveUpdate(t)},this._handleTouchEnd=e=>{if(e.target===this.canvas){e.cancelable&&e.preventDefault();const t=e.changedTouches[0];this._strokeEnd(t)}},this._handlePointerStart=e=>{e.preventDefault(),this._strokeBegin(e)},this._handlePointerMove=e=>{this._strokeMoveUpdate(e)},this._handlePointerEnd=e=>{this._drawingStroke&&(e.preventDefault(),this._strokeEnd(e))},this.velocityFilterWeight=t.velocityFilterWeight||.7,this.minWidth=t.minWidth||.5,this.maxWidth=t.maxWidth||2.5,this.throttle="throttle"in t?t.throttle:16,this.minDistance="minDistance"in t?t.minDistance:5,this.dotSize=t.dotSize||0,this.penColor=t.penColor||"black",this.backgroundColor=t.backgroundColor||"rgba(0,0,0,0)",this.compositeOperation=t.compositeOperation||"source-over",this._strokeMoveUpdate=this.throttle?function(e,t=250){let i,s,o,a=0,n=null;const r=()=>{a=Date.now(),n=null,i=e.apply(s,o),n||(s=null,o=[])};return function(...d){const l=Date.now(),c=t-(l-a);return s=this,o=d,c<=0||c>t?(n&&(clearTimeout(n),n=null),a=l,i=e.apply(s,o),n||(s=null,o=[])):n||(n=window.setTimeout(r,c)),i}}(s.prototype._strokeUpdate,this.throttle):s.prototype._strokeUpdate,this._ctx=e.getContext("2d"),this.clear(),this.on()}clear(){const{_ctx:t,canvas:e}=this;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height),this._data=[],this._reset(this._getPointGroupOptions()),this._isEmpty=!0}fromDataURL(e,t={}){return new Promise((n,s)=>{const o=new Image,i=t.ratio||window.devicePixelRatio||1,a=t.width||this.canvas.width/i,r=t.height||this.canvas.height/i,c=t.xOffset||0,l=t.yOffset||0;this._reset(this._getPointGroupOptions()),o.onload=()=>{this._ctx.drawImage(o,c,l,a,r),n()},o.onerror=e=>{s(e)},o.crossOrigin="anonymous",o.src=e,this._isEmpty=!1})}toDataURL(e="image/png",t){return"image/svg+xml"===e?("object"!=typeof t&&(t=void 0),`data:image/svg+xml;base64,${btoa(this.toSVG(t))}`):("number"!=typeof t&&(t=void 0),this.canvas.toDataURL(e,t))}on(){this.canvas.style.touchAction="none",this.canvas.style.msTouchAction="none",this.canvas.style.userSelect="none";const e=/Macintosh/.test(navigator.userAgent)&&"ontouchstart"in document;window.PointerEvent&&!e?this._handlePointerEvents():(this._handleMouseEvents(),"ontouchstart"in window&&this._handleTouchEvents())}off(){this.canvas.style.touchAction="auto",this.canvas.style.msTouchAction="auto",this.canvas.style.userSelect="auto",this.canvas.removeEventListener("pointerdown",this._handlePointerStart),this.canvas.removeEventListener("pointermove",this._handlePointerMove),this.canvas.ownerDocument.removeEventListener("pointerup",this._handlePointerEnd),this.canvas.removeEventListener("mousedown",this._handleMouseDown),this.canvas.removeEventListener("mousemove",this._handleMouseMove),this.canvas.ownerDocument.removeEventListener("mouseup",this._handleMouseUp),this.canvas.removeEventListener("touchstart",this._handleTouchStart),this.canvas.removeEventListener("touchmove",this._handleTouchMove),this.canvas.removeEventListener("touchend",this._handleTouchEnd)}isEmpty(){return this._isEmpty}fromData(e,{clear:t=!0}={}){t&&this.clear(),this._fromData(e,this._drawCurve.bind(this),this._drawDot.bind(this)),this._data=this._data.concat(e)}toData(){return this._data}_getPointGroupOptions(e){return{penColor:e&&"penColor"in e?e.penColor:this.penColor,dotSize:e&&"dotSize"in e?e.dotSize:this.dotSize,minWidth:e&&"minWidth"in e?e.minWidth:this.minWidth,maxWidth:e&&"maxWidth"in e?e.maxWidth:this.maxWidth,velocityFilterWeight:e&&"velocityFilterWeight"in e?e.velocityFilterWeight:this.velocityFilterWeight,compositeOperation:e&&"compositeOperation"in e?e.compositeOperation:this.compositeOperation}}_strokeBegin(e){if(!this.dispatchEvent(new CustomEvent("beginStroke",{detail:e,cancelable:!0})))return;this._drawingStroke=!0;const t=this._getPointGroupOptions(),n=Object.assign(Object.assign({},t),{points:[]});this._data.push(n),this._reset(t),this._strokeUpdate(e)}_strokeUpdate(e){if(!this._drawingStroke)return;if(0===this._data.length)return void this._strokeBegin(e);this.dispatchEvent(new CustomEvent("beforeUpdateStroke",{detail:e}));const a=e.clientX,r=e.clientY,c=void 0!==e.pressure?e.pressure:void 0!==e.force?e.force:0,t=this._createPoint(a,r,c),i=this._data[this._data.length-1],s=i.points,n=s.length>0&&s[s.length-1],l=!!n&&t.distanceTo(n)<=this.minDistance,o=this._getPointGroupOptions(i);if(!n||!n||!l){const e=this._addPoint(t,o);n?e&&this._drawCurve(e,o):this._drawDot(t,o),s.push({time:t.time,x:t.x,y:t.y,pressure:t.pressure})}this.dispatchEvent(new CustomEvent("afterUpdateStroke",{detail:e}))}_strokeEnd(e){this._drawingStroke&&(this._strokeUpdate(e),this._drawingStroke=!1,this.dispatchEvent(new CustomEvent("endStroke",{detail:e})))}_handlePointerEvents(){this._drawingStroke=!1,this.canvas.addEventListener("pointerdown",this._handlePointerStart),this.canvas.addEventListener("pointermove",this._handlePointerMove),this.canvas.ownerDocument.addEventListener("pointerup",this._handlePointerEnd)}_handleMouseEvents(){this._drawingStroke=!1,this.canvas.addEventListener("mousedown",this._handleMouseDown),this.canvas.addEventListener("mousemove",this._handleMouseMove),this.canvas.ownerDocument.addEventListener("mouseup",this._handleMouseUp)}_handleTouchEvents(){this.canvas.addEventListener("touchstart",this._handleTouchStart),this.canvas.addEventListener("touchmove",this._handleTouchMove),this.canvas.addEventListener("touchend",this._handleTouchEnd)}_reset(e){this._lastPoints=[],this._lastVelocity=0,this._lastWidth=(e.minWidth+e.maxWidth)/2,this._ctx.fillStyle=e.penColor,this._ctx.globalCompositeOperation=e.compositeOperation}_createPoint(e,n,s){const o=this.canvas.getBoundingClientRect();return new t(e-o.left,n-o.top,s,(new Date).getTime())}_addPoint(t,n){const{_lastPoints:s}=this;if(s.push(t),s.length>2){3===s.length&&s.unshift(s[0]);const t=this._calculateCurveWidths(s[1],s[2],n),o=e.fromPoints(s,t);return s.shift(),o}return null}_calculateCurveWidths(e,t,n){const s=n.velocityFilterWeight*t.velocityFrom(e)+(1-n.velocityFilterWeight)*this._lastVelocity,o=this._strokeWidth(s,n),i={end:o,start:this._lastWidth};return this._lastVelocity=s,this._lastWidth=o,i}_strokeWidth(e,t){return Math.max(t.maxWidth/(e+1),t.minWidth)}_drawCurveSegment(e,t,n){const s=this._ctx;s.moveTo(e,t),s.arc(e,t,n,0,2*Math.PI,!1),this._isEmpty=!1}_drawCurve(e,t){const n=this._ctx,o=e.endWidth-e.startWidth,s=2*Math.ceil(e.length());n.beginPath(),n.fillStyle=t.penColor;for(let c=0;c<s;c+=1){const n=c/s,l=n*n,d=l*n,i=1-n,u=i*i,h=u*i;let a=h*e.startPoint.x;a+=3*u*n*e.control1.x,a+=3*i*l*e.control2.x,a+=d*e.endPoint.x;let r=h*e.startPoint.y;r+=3*u*n*e.control1.y,r+=3*i*l*e.control2.y,r+=d*e.endPoint.y;const m=Math.min(e.startWidth+d*o,t.maxWidth);this._drawCurveSegment(a,r,m)}n.closePath(),n.fill()}_drawDot(e,t){const n=this._ctx,s=t.dotSize>0?t.dotSize:(t.minWidth+t.maxWidth)/2;n.beginPath(),this._drawCurveSegment(e.x,e.y,s),n.closePath(),n.fillStyle=t.penColor,n.fill()}_fromData(e,n,s){for(const a of e){const{points:i}=a,o=this._getPointGroupOptions(a);if(i.length>1)for(let e=0;e<i.length;e+=1){const s=i[e],r=new t(s.x,s.y,s.pressure,s.time);0===e&&this._reset(o);const a=this._addPoint(r,o);a&&n(a,o)}else this._reset(o),s(i[0],o)}}toSVG({includeBackgroundColor:e=!1}={}){const i=this._data,n=Math.max(window.devicePixelRatio||1,1),s=this.canvas.width/n,o=this.canvas.height/n,t=document.createElementNS("http://www.w3.org/2000/svg","svg");if(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),t.setAttribute("viewBox",`0 0 ${s} ${o}`),t.setAttribute("width",s.toString()),t.setAttribute("height",o.toString()),e&&this.backgroundColor){const e=document.createElement("rect");e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill",this.backgroundColor),t.appendChild(e)}return this._fromData(i,(e,{penColor:n})=>{const s=document.createElement("path");if(!(isNaN(e.control1.x)||isNaN(e.control1.y)||isNaN(e.control2.x)||isNaN(e.control2.y))){const o=`M ${e.startPoint.x.toFixed(3)},${e.startPoint.y.toFixed(3)} C ${e.control1.x.toFixed(3)},${e.control1.y.toFixed(3)} ${e.control2.x.toFixed(3)},${e.control2.y.toFixed(3)} ${e.endPoint.x.toFixed(3)},${e.endPoint.y.toFixed(3)}`;s.setAttribute("d",o),s.setAttribute("stroke-width",(2.25*e.endWidth).toFixed(3)),s.setAttribute("stroke",n),s.setAttribute("fill","none"),s.setAttribute("stroke-linecap","round"),t.appendChild(s)}},(e,{penColor:n,dotSize:s,minWidth:o,maxWidth:i})=>{const a=document.createElement("circle"),r=s>0?s:(o+i)/2;a.setAttribute("r",r.toString()),a.setAttribute("cx",e.x.toString()),a.setAttribute("cy",e.y.toString()),a.setAttribute("fill",n),t.appendChild(a)}),t.outerHTML}}const playPanel=document.getElementById("playPanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),tegakiPanel=document.getElementById("tegakiPanel");let canvases=[...tegakiPanel.getElementsByTagName("canvas")];const gameTime=180;let gameTimer,pads=[],problems=[],hinted=!1,problemCandidate,answerEn="cat",answerJa="ねこ",correctCount=0,totalCount=0;const canvasCache=document.createElement("canvas").getContext("2d",{alpha:!1,willReadFrequently:!0}),audioContext=new globalThis.AudioContext,audioBufferCache={};loadAudio("end","mp3/end.mp3"),loadAudio("correct","mp3/correct3.mp3");let englishVoices=[];loadVoices(),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}}),t=["com.apple.speech.synthesis.voice.Bahh","com.apple.speech.synthesis.voice.Albert","com.apple.speech.synthesis.voice.Hysterical","com.apple.speech.synthesis.voice.Organ","com.apple.speech.synthesis.voice.Cellos","com.apple.speech.synthesis.voice.Zarvox","com.apple.speech.synthesis.voice.Bells","com.apple.speech.synthesis.voice.Trinoids","com.apple.speech.synthesis.voice.Boing","com.apple.speech.synthesis.voice.Whisper","com.apple.speech.synthesis.voice.Deranged","com.apple.speech.synthesis.voice.GoodNews","com.apple.speech.synthesis.voice.BadNews","com.apple.speech.synthesis.voice.Bubbles"];e.then(e=>{englishVoices=e.filter(e=>e.lang=="en-US").filter(e=>!t.includes(e.voiceURI))})}function loopVoice(e,t){speechSynthesis.cancel();const n=new globalThis.SpeechSynthesisUtterance(e);n.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],n.lang="en-US";for(let e=0;e<t;e++)speechSynthesis.speak(n)}function respeak(){loopVoice(answerEn,1)}function setTegakiPanel(){for(;tegakiPanel.firstChild;)tegakiPanel.removeChild(tegakiPanel.lastChild);pads=[];for(let e=0;e<answerEn.length;e++){const t=createTegakiBox();tegakiPanel.appendChild(t)}const e=tegakiPanel.children;canvases=[...e].map(e=>e.querySelector("canvas"))}function showPredictResult(e,t){const i=canvases.indexOf(e),s=answerEn[i];let o=!1;for(let e=0;e<t.length;e++)if(t[e]==s){o=!0;break}o?e.setAttribute("data-predict",s):e.setAttribute("data-predict",t[0]);let n="";for(let e=0;e<canvases.length;e++){const t=canvases[e].getAttribute("data-predict");t?n+=t:n+=" "}return document.getElementById("reply").textContent=n,n}function initSignaturePad(e){const t=new s(e,{minWidth:2,maxWidth:2,penColor:"black",backgroundColor:"white",throttle:0,minDistance:0});return t.addEventListener("endStroke",()=>{predict(t.canvas)}),t}function getImageData(e){canvasCache.drawImage(e,0,0,28,28);const n=canvasCache.getImageData(0,0,28,28),t=n.data;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2];return n}function predict(e){const t=getImageData(e),n=canvases.indexOf(e);worker.postMessage({imageData:t,pos:n})}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e)+e)}function hideAnswer(){document.getElementById("answerEn").classList.add("d-none")}function showAnswer(){hinted=!0,loopVoice(answerEn,1),document.getElementById("answerEn").classList.remove("d-none")}function nextProblem(){hinted=!1,problemCandidate.length<=0&&(problemCandidate=problems.slice());const e=problemCandidate.splice(getRandomInt(0,problemCandidate.length),1)[0];document.getElementById("reply").textContent="";const[t,n,s]=e;answerEn=t,answerJa=n,document.getElementById("answerEn").textContent=answerEn,document.getElementById("answerJa").textContent=answerJa,setTegakiPanel(),document.getElementById("mode").textContent=="EASY"?(loopVoice(answerEn,3),document.getElementById("answerEn").classList.remove("d-none")):hideAnswer(),document.getElementById("emoji").textContent=s}function initProblems(){const e=document.getElementById("courseOption").radio.value;fetch("data/"+e+".csv").then(e=>e.text()).then(e=>{problems=[],e.trim().split(/\n/).forEach(e=>{const[t,n,s]=e.split(",");problems.push([t,n,s])}),problemCandidate=problems.slice()})}function countdown(){countPanel.classList.remove("d-none"),infoPanel.classList.add("d-none"),playPanel.classList.add("d-none"),scorePanel.classList.add("d-none");const e=document.getElementById("counter");e.textContent=3;const t=setInterval(()=>{const n=["skyblue","greenyellow","violet","tomato"];if(parseInt(e.textContent)>1){const t=parseInt(e.textContent)-1;e.style.backgroundColor=n[t],e.textContent=t}else clearTimeout(t),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),correctCount=totalCount=0,startGameTimer(),nextProblem()},1e3)}function startGame(){clearInterval(gameTimer),initTime(),countdown()}function startGameTimer(){const e=document.getElementById("time");gameTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(gameTimer),playAudio("end"),playPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),scoring())},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}function scoring(){document.getElementById("score").textContent=`${correctCount} / ${totalCount}`}function changeMode(e){e.target.textContent=="EASY"?e.target.textContent="HARD":e.target.textContent="EASY"}class TegakiBox extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.adoptedStyleSheets=[globalCSS];const e=document.getElementById("tegaki-box").content.cloneNode(!0),t=e.querySelector("use"),s=t.getAttribute("href").slice(1),o=document.getElementById(s).firstElementChild.cloneNode(!0);t.replaceWith(o),this.shadowRoot.appendChild(e);const i=this.shadowRoot.querySelector("canvas"),n=initSignaturePad(i);this.shadowRoot.querySelector(".eraser").onclick=()=>{n.clear()},pads.push(n),document.documentElement.getAttribute("data-bs-theme")=="dark"&&this.shadowRoot.querySelector("canvas").setAttribute("style","filter: invert(1) hue-rotate(180deg);")}}customElements.define("tegaki-box",TegakiBox);function createTegakiBox(){const e=document.createElement("div"),n=document.getElementById("tegaki-box").content.cloneNode(!0);e.appendChild(n);const s=e.querySelector("canvas"),t=initSignaturePad(s);return e.querySelector(".eraser").onclick=()=>{t.clear()},pads.push(t),e}function getGlobalCSS(){let e="";for(const t of document.styleSheets)try{for(const n of t.cssRules)e+=n.cssText}catch{}const t=new CSSStyleSheet;return t.replaceSync(e),t}const globalCSS=getGlobalCSS();canvases.forEach(e=>{const t=initSignaturePad(e);pads.push(t),e.parentNode.querySelector(".eraser").onclick=()=>{t.clear(),showPredictResult(e," ")}});const worker=new Worker("worker.js");worker.addEventListener("message",e=>{const t=showPredictResult(canvases[e.data.pos],e.data.result);t==answerEn&&(totalCount+=1,hinted||(correctCount+=1),playAudio("correct",.3),loopVoice(answerEn,1),document.getElementById("reply").textContent="⭕ "+answerEn,nextProblem())}),initProblems(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("mode").onclick=changeMode,document.getElementById("restartButton").onclick=startGame,document.getElementById("startButton").onclick=startGame,document.getElementById("respeak").onclick=respeak,document.getElementById("showAnswer").onclick=showAnswer,document.getElementById("mode").onclick=changeMode,document.getElementById("courseOption").onchange=initProblems,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})